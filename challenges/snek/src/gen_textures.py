#!/usr/bin/env python3
#
# @mebeim - 2025-09-27
#
# Gen textures for chars and images used in the game, as well as C header file
# to load them.
#
# Font chars textures are generated as RGBA32 and use SDL_BLENDMODE_BLEND so
# they can be drawn on top of other stuff. Img textures are generated as RGB24
# and use SDL_BLENDMODE_BLEND as they don't need transparency. This also makes
# it "easy" to load an arbitrary file (i.e. the flag) as texture pixel data and
# recover its content unmodified from the final PNG screenshot, which is also
# RGB24. If all textures were to use RGBA32 + blending, one would need to
# reverse the blending back to extract the flag.
#

from pathlib import Path
from textwrap import dedent
from typing import Iterator

from PIL import Image


MY_DIR       = Path(__file__).parent
IMG_DIR      = MY_DIR / 'img'
OUT_DIR      = MY_DIR / 'game'
C_HEADER     = MY_DIR / 'src' / 'textures.h'
TEXTURES_DIR = OUT_DIR / 'textures'

# PNG path, fallback color
IMGS = [
	(IMG_DIR / 'apple.png', (255, 0, 0)),
	(IMG_DIR / 'head.png',  (200, 150, 0)),
	(IMG_DIR / 'snek.png', (0, 200, 0)),
]

FONT = {
	'A': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##..........##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##..........##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##..........##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  ....        ....  ',
		'                    ',
	],
	'C': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##.............  ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.............  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'E': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##.............  ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##............   ',
		'  .#############.   ',
		'  .#############.   ',
		'  .##............   ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.............  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'G': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##.............  ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.  ..........  ',
		'  .##.  .########.  ',
		'  .##.  .########.  ',
		'  .##.  .......##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##..........##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'M': [
		'                    ',
		'  ....        ....  ',
		'  .##.        .##.  ',
		'  .###.      .###.  ',
		'  .####.    .####.  ',
		'  .##.##.  .##.##.  ',
		'  .##..##..##..##.  ',
		'  .##. .####. .##.  ',
		'  .##.  .##.  .##.  ',
		'  .##.  ....  .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  ....        ....  ',
		'                    ',
	],
	'O': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##..........##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##..........##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'R': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##..........##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##..........##.  ',
		'  .##############.  ',
		'  .#############.   ',
		'  .##.......##..    ',
		'  .##.      .##.    ',
		'  .##.       .##.   ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  ....        ....  ',
		'                    ',
	],
	'S': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##.............  ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.............  ',
		'  .##############.  ',
		'  .##############.  ',
		'              .##.  ',
		'              .##.  ',
		'              .##.  ',
		'              .##.  ',
		'  .............##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'V': [
		'                    ',
		'  ....        ....  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'   .##.      .##.   ',
		'   .##.      .##.   ',
		'    .##.    .##.    ',
		'    .##.    .##.    ',
		'     .##.  .##.     ',
		'     .##.  .##.     ',
		'      .##..##.      ',
		'      .##..##.      ',
		'       .####.       ',
		'        .##.        ',
		'        ....        ',
		'                    ',
	],
	'0': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##..........##.  ',
		'  .##.  ....  .##.  ',
		'  .##.  .##.  .##.  ',
		'  .##.  .##.  .##.  ',
		'  .##.  .##.  .##.  ',
		'  .##.  .##.  .##.  ',
		'  .##.  .##.  .##.  ',
		'  .##.  .##.  .##.  ',
		'  .##.  .##.  .##.  ',
		'  .##.  .##.  .##.  ',
		'  .##.  ....  .##.  ',
		'  .##..........##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'1': [
		'                    ',
		'   .........        ',
		'   .#######.        ',
		'   .#######.        ',
		'   ......##.        ',
		'        .##.        ',
		'        .##.        ',
		'        .##.        ',
		'        .##.        ',
		'        .##.        ',
		'        .##.        ',
		'        .##.        ',
		'        .##.        ',
		'        .##.        ',
		'        .##.        ',
		'  .......##.......  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'2': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##..........##.  ',
		'  ....        .##.  ',
		'              .##.  ',
		'             ..##.  ',
		'           ..##..   ',
		'         ..##..     ',
		'       ..##..       ',
		'     ..##..         ',
		'   ..##..           ',
		'  .##..             ',
		'  .##.              ',
		'  .##.............  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'3': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .............##.  ',
		'              .##.  ',
		'              .##.  ',
		'        .......##.  ',
		'        .########.  ',
		'        .########.  ',
		'        .......##.  ',
		'              .##.  ',
		'              .##.  ',
		'              .##.  ',
		'              .##.  ',
		'  .............##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'4': [
		'                    ',
		' ....         ....  ',
		' .##.         .##.  ',
		' .##.         .##.  ',
		' .##.         .##.  ',
		' .##.         .##.  ',
		' .##.         .##.  ',
		' .##.         .##.  ',
		' .##...........##.  ',
		' .###############.  ',
		' .###############.  ',
		' ..............##.  ',
		'              .##.  ',
		'              .##.  ',
		'              .##.  ',
		'              .##.  ',
		'              .##.  ',
		'              .##.  ',
		'              ....  ',
		'                    ',
	],
	'5': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##.............  ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.............  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .............##.  ',
		'              .##.  ',
		'              .##.  ',
		'              .##.  ',
		'  .............##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'6': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##.............  ',
		'  .##.              ',
		'  .##.              ',
		'  .##.              ',
		'  .##.............  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##..........##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##..........##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'7': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .............##.  ',
		'              .##.  ',
		'             .##.   ',
		'            .##.    ',
		'           .##.     ',
		'          .##.      ',
		'         .##.       ',
		'        .##.        ',
		'       .##.         ',
		'      .##.          ',
		'     .##.           ',
		'    .##.            ',
		'   .##.             ',
		'  .##.              ',
		'  ....              ',
		'                    ',
	],
	'8': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##..........##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##..........##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##..........##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##..........##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
	'9': [
		'                    ',
		'  ................  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .##..........##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##.        .##.  ',
		'  .##..........##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  .............##.  ',
		'              .##.  ',
		'              .##.  ',
		'              .##.  ',
		'  .............##.  ',
		'  .##############.  ',
		'  .##############.  ',
		'  ................  ',
		'                    ',
	],
}


def art_to_rgba32(data: list[str]) -> Iterator[int]:
	assert len(data) == 20

	for line in data:
		assert len(line) == 20

		for px in line:
			assert px in ' .#'

			match px:
				case ' ':
					yield (0, 0, 0, 0)
				case '.':
					yield (50, 50, 50, 255)
				case '#':
					yield (255, 255, 255, 255)


def gen_img_textures():
	for img_path, _ in IMGS:
		out_path = (TEXTURES_DIR / img_path.stem).with_suffix('.bin')
		img = Image.open(img_path).convert('RGB')
		px = img.getdata()

		with out_path.open('wb') as f:
			for p in px:
				f.write(bytearray(p))


def gen_font_textures():
	for char, ascii_art in FONT.items():
		out_path = (TEXTURES_DIR / f'font_{char}').with_suffix('.bin')

		with out_path.open('wb') as f:
			for p in art_to_rgba32(ascii_art):
				f.write(bytearray(p))


def gen_c_header():
	with C_HEADER.open('w') as header:
		texture_path_max_len = 31

		header.write(dedent(f'''\
			/* Auto-generated by gen_textures.py */
			#pragma once

			#include <SDL2/SDL.h>

			struct TextureInfo {{
				char path[{texture_path_max_len} + 1];
				Uint32 pixel_format;
				Uint32 pixel_size;
				Uint32 blend_mode;
				Uint8 fallback_color[4];
			}};

			'''))

		sorted_imgs = sorted(IMGS)
		sorted_chars = sorted(FONT.keys())
		n_textures = len(sorted_imgs) + len(sorted_chars)

		header.write(f'static struct TextureInfo texture_info[{n_textures}] = {{\n')

		for img_path, fallback_color in sorted_imgs:
			out_path = (TEXTURES_DIR / img_path.stem).with_suffix('.bin')
			runtime_path = str(out_path.relative_to(OUT_DIR))
			assert len(runtime_path) < texture_path_max_len
			assert '"' not in runtime_path

			color_arr = '{' + ', '.join(map(str, fallback_color)) + '}'
			header.write(f'\t{{"{runtime_path}", SDL_PIXELFORMAT_RGB24, 3, SDL_BLENDMODE_NONE, {color_arr}}},\n')

		for char in sorted_chars:
			out_path = (TEXTURES_DIR / f'font_{char}').with_suffix('.bin')
			runtime_path = str(out_path.relative_to(OUT_DIR))
			assert len(runtime_path) < texture_path_max_len
			assert '"' not in runtime_path

			# Font chars fallback to transparent (invisible)
			header.write(f'\t{{"{runtime_path}", SDL_PIXELFORMAT_RGBA32, 4, SDL_BLENDMODE_BLEND, {{0, 0, 0, 0}}}},\n')

		header.write('};\n\n')
		header.write(f'static SDL_Texture *textures[{n_textures}];\n\n')

		idx = 0
		for img_path, _ in sorted_imgs:
			texture_name = img_path.stem
			header.write(f'#define TXT_{texture_name} textures[{idx}]\n')
			idx += 1

		for texture_name in sorted_chars:
			header.write(f'#define TXT_{texture_name} textures[{idx}]\n')
			idx += 1

		header.write(dedent('''\

			#define ARRAY_LENGTH(a) (sizeof(a) / sizeof(*a))
			_Static_assert(ARRAY_LENGTH(texture_info) == ARRAY_LENGTH(textures));
			'''))


def main():
	gen_img_textures()
	gen_font_textures()
	gen_c_header()


if __name__ == '__main__':
	main()
