#
# @mebeim - 2025-09-27
#
SRCDIR := src
OUTDIR := game
SRCS   := $(wildcard $(SRCDIR)/*.c)
OBJS   := $(SRCS:.c=.o)
DEPS   := $(OBJS:.o=.d)

TEXTURES_IMGDIR   := img
TEXTURES_OUTDIR   := $(OUTDIR)/textures
TEXTURES_H        := $(SRCDIR)/textures.h
TEXTURES_IMGS     := $(wildcard $(TEXTURES_IMGDIR)/*.png)
TEXTURES_IMG_BINS := $(patsubst $(TEXTURES_IMGDIR)/%.png,$(TEXTURES_OUTDIR)/%.bin,$(TEXTURES_IMGS))

CHALL_NAME    := snek
BINARY        := $(OUTDIR)/$(CHALL_NAME)
SERVER_SCRIPT := $(OUTDIR)/server.py
ARCHIVE_DIR   := $(CHALL_NAME)
ARCHIVE       := $(CHALL_NAME).tar.gz

FLAG_FILE    := $(OUTDIR)/flag
FLAG_CONTENT := ptm{n0_s73p_0n_l00000000000000n6_sn3k_81c5cc798a7d0fd9}

CC      := gcc
CFLAGS  := -MMD -std=gnu11 -Wall -Wextra -fstack-protector-strong $(shell CC=$(CC) sdl2-config --cflags)
LDFLAGS := -Wl,-z,relro,-z,now
LDLIBS  := $(shell CC=$(CC) sdl2-config --libs) -lSDL2_image

ifeq ($(DEBUG),1)
	CFLAGS += -g
endif

ifneq ($(V),1)
	MAKEFLAGS += --silent
endif

.DEFAULT_GOAL := all

-include $(DEPS)

all: $(BINARY) $(FLAG_FILE) $(TEXTURES_IMG_BINS)
.PHONY: all

test: all ../expl.py
	@echo 'TEST'
	../expl.py $(BINARY)
.PHONY: test

$(BINARY): $(OBJS) | $(OUTDIR)
	@echo 'CCLD     $@'
	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $^ $(LDLIBS)

$(SRCDIR)/%.o: $(SRCDIR)/%.c $(TEXTURES_H) | $(OUTDIR)
	@echo 'CC       $@'
	$(CC) $(CFLAGS) -c -o $@ $<

$(FLAG_FILE):
	@echo 'FLAG     $@'
	echo '$(FLAG_CONTENT)' > $@

# No good way (that I know of) to express dependencies for textures purely
# generated by gen_textures.py so whatever, only do this for img textures and
# header file.
$(TEXTURES_IMG_BINS) $(TEXTURES_H): gen_textures.py $(TEXTURES_IMGS) | $(TEXTURES_OUTDIR)
	@echo 'TEXTURES $(TEXTURES_OUTDIR) $@'
	./gen_textures.py

$(OUTDIR):
	@echo 'MKDIR    $@'
	mkdir -p $@

$(TEXTURES_OUTDIR):
	@echo 'MKDIR    $@'
	mkdir -p $@

archive: $(ARCHIVE)
.PHONY: archive

$(ARCHIVE): $(BINARY) $(SERVER_SCRIPT) $(FLAG_FILE) $(TEXTURES_IMG_BINS) docker-compose.yml Dockerfile
	@echo 'ARCHIVE  $@'
	mkdir -p $(ARCHIVE_DIR)

	cp -r $(OUTDIR) docker-compose.yml Dockerfile $(ARCHIVE_DIR)
# Remove source code comments if any
	sed -i -e '/^\s*#\(\s\|$$\)/d' $(ARCHIVE_DIR)/game/server.py
# Redact flag
	echo 'ptm{REDACTED}' > $(ARCHIVE_DIR)/game/flag

	tar czf $(ARCHIVE) $(ARCHIVE_DIR)
	rm -rf $(ARCHIVE_DIR)

clean:
	@echo 'CLEAN    $(SRCDIR)/textures.h'
	rm -f '$(SRCDIR)/textures.h'

	@echo 'CLEAN    $(BINARY)'
	rm -f '$(BINARY)'

	@echo 'CLEAN    $(FLAG_FILE)'
	rm -f '$(FLAG_FILE)'

	@echo 'CLEAN    $(TEXTURES_OUTDIR)'
	rm -fr '$(TEXTURES_OUTDIR)'

	@echo 'CLEAN    $(ARCHIVE_DIR)'
	rm -fr '$(ARCHIVE_DIR)'

	@echo 'CLEAN    $(ARCHIVE)'
	rm -f '$(ARCHIVE)'
.PHONY: clean
